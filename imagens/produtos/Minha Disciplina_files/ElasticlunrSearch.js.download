var index = elasticlunr(function () {
    this.use(elasticlunr.pt);
    this.addField('title');
    this.addField('body');
    this.addField('tags');
    this.addField('keyword');
    this.addField('relation');
    this.addField('type');
    this.setRef('id');
});
var tagList,
    specialList = [],
    fuzzy = FuzzySet(['']);

var locuradoRafaStr = "",
    locuradoRafaCount = 0,
    locuradoRafaAddDoc = "";

//console.log("INDEX COMPLETO:");
//console.log(index);

function Busca() {
    var att,
        i,
        userinput = document.getElementById("searchInput").value,
        tempInput = userinput,
        transform = tempInput.split(' ' || ',' || ';' || '?'),
        getter;
    //console.log(transform);
    if (transform != null) {
        for (i = 0; i < transform.length; i++) {
            getter = fuzzy.get(transform[i]);
            if (getter != null && getter.length > 0 && getter[0][0] > 0.6) {
                tempInput = tempInput.replace(transform[i], getter[0][1]);
            } else if (getter != null && getter.length > 0) {
                //console.log(getter[0]);
            }
        }
    }

    var busca = index.search(tempInput, {
        fields: {
            title: {boost: 1},
            body: {boost: 1},
            keyword: {boost: 2}
        },
        bool: "OR",
        expand: true
    });
    //console.log(busca);

    for (i = 0; i < document.getElementsByClassName("result").length; i++) {
        att = document.createAttribute("style");
        att.value = "display : none;";
        document.getElementsByClassName("result")[i].setAttributeNode(att);
    }

    if (busca.length > 0) {
        for (i = 0; i < busca.length; i++) {
            att = document.createAttribute("style");
            att.value = "display : block;";
            document.getElementById(busca[i].ref).setAttributeNode(att);
            if (i + 1 < busca.length) {
                document.getElementById(busca[i].ref).parentNode.insertBefore(document.getElementById(busca[i].ref), document.getElementById(busca[i + 1].ref));
            }
        }
    }
}

$(document).ready(function () {
    var chatButton = document.getElementById("chatButton");
    chatButton.style.display = "block";
    chatButton.classList.add('idle');
});

function f() {
    document.getElementById("ActioDoForm").value = "CASE_DO_SWITCH"; //opcional caso queira mudar o case
    var $form = $("#meuForm"); //cria variável do form
    /** Chama método post
     * PARAMETERS:
     * formAction - vai ser a página chamada pelo médoto, pode ser passado uma String, mas nesse caso é o atributte action="" que está no form, normalmente vai ser o "Controller"
     * form - form serializado, como estamos mandando um form sem fazer um submit e preciso passar ele serializado como parameter
     * function - função que será realizada quando retornar do java, se houver retorno de valor do java pode ser criado um parametro na função que será esse valor
     * */
    $.post($form.attr("action"), $form.serialize(), function (response) {
        $.each(response, function (ind, value) { //opcional caso "response" seja uma lista, básicamente um foreach (ind é o index e value o response atual)

        });
    }).error(function () { //opcional caso queira uma tratativa pra quando houver problema no post, depreciado em versões novas (ver "fail" e "done")
    });
}

function loadQuestions(text, waitTime, buttonList) {
    document.getElementById("headformAction").value = "ON_PAGE_LOAD";
    var $form = $("#headform");
    $.post($form.attr("action"), $form.serialize(), function (response) {
        var script = document.createElement("script");
        var content = document.createTextNode(response);
        //document.body.innerHTML += "<script type=\"text/javascript\">" + response + "</script>";
        script.appendChild(content);
        document.body.appendChild(script);
        console.log(index);
        var busca = getDocById(16);
        botAnswer(busca.doc.body, 500, getQuestionOptions(busca));
        document.getElementById("userInput").disabled = false;
    }).error(function () {
        closeButtonClick();
    });
    //console.log("chamou page load");
    /*var $form = $("#headform");
    $.post($form.attr("action"), $form.serialize(), function (response) {
        //console.log(response);
        //SpecialQuestions();
        $.each(response, function (ind, value) {
            var question = value.split('|');
            if (!isNaN(parseInt(question[0]))) {
                $("#questList").append('<li id="' + question[0] + '" class="result" style="display : none;"><a href="./Controller?ACTION=PERGUNTA&PKQUESTION=' + question[0] + '">' + question[1] + '</a></li>');
            } else {
                $("#questList").append('<li id="' + question[0] + '" class="result" style="display : none;"><a href="./Controller?ACTION=SERVICE&PKQUESTION=' + question[0] + '">' + question[1] + '</a></li>');
            }
            var doc = {
                "id": question[0],
                "title": question[1],
                "body": question[2],
                "tags": question[3],
                "keyword": question[4],
                "relation": question[5],
                "type": question[6]
            };
            if (locuradoRafaStr.indexOf("doc" + locuradoRafaCount) === -1){
                locuradoRafaStr += "var doc" + locuradoRafaCount + " = {" +
                    "\n'id': \"" + question[0] + "\"," +
                    "\n'title': \"" + question[1] + "\"," +
                    "\n'body': \"" + question[2] + "\"," +
                    "\n'tags': \"" + question[3] + "\"," +
                    "\n'keyword': \"" + question[4] + "\"," +
                    "\n'relation': \"" + question[5] + "\"," +
                    "\n'type': \"" + question[6] + "\"," +
                    "\n};\n";
                locuradoRafaAddDoc += "\nindex.addDoc(doc"+ locuradoRafaCount +")";
                locuradoRafaCount++;
            }
            index.addDoc(doc);
            var str = question[4].split(' ');
            var strTitle = question[1].split(' ' || ',' || ';' || '?' || '.' || ":");
            for (var i = 0; i < str.length; i++) {
                fuzzy.add(str[i]);
            }
            for (var i = 0; i < strTitle.length; i++) {
                fuzzy.add(strTitle[i]);
            }
            //console.log(question);3
        });
        console.log(index);
        console.log(locuradoRafaStr);
        console.log(locuradoRafaAddDoc);
        var busca = getDocById(16);
        botAnswer(busca.doc.body, 500, getQuestionOptions(busca));
        document.getElementById("userInput").disabled = false;
    }).error(function () {
        closeButtonClick();
    });*/
}

function getDocById(id) {
    var doc,
        i,
        cont;
    cont = 0;
    if (id !== undefined && id !== null) {
        for (i = 0; i < index.documentStore.length;) {
            if (index.documentStore.docs[cont] !== undefined) {
                if (index.documentStore.docs[cont].id === id.toString()) {
                    doc = {
                        "ref": index.documentStore.docs[cont].id,
                        "doc": index.documentStore.docs[cont]
                    };
                    return doc;
                }
                i++;
            }
            cont++;
        }
    }
    return null;
}

//$(document).ready(function () {
//    document.getElementById("headformAction").value = "LOAD_QUESTIONS";
//    var $form = $("#headform");
//    $.post($form.attr("action"), $form.serialize(), function (response) {
//        $.each(response, function (ind, value) {
//            var question = value.split("|");
//            $("#questionList").append('<li><span class="qst-item-color"></span><a href="./Controller?ACTION=PERGUNTA&PKQUESTION=' + question[0] + '">' + question[1] + '</a></li>');
//        });
//    });
//});

$(document).ready(function () {
    document.getElementById("headformAction").value = "LOAD_TAGS";
    var $form = $("#headform");
    $.post($form.attr("action"), $form.serialize(), function (response) {
        tagList = response;
    }).error(function () {
        closeButtonClick();
    });
});

$(function () {
    $("#userInput").keydown(function (event) {
        if (event.which === 13) {
            buscaChat();
        }
    });
});